//
//  GoHomeViewController.m
//  SubWay
//
//  Created by Gary on 14-4-25.
//  Copyright (c) 2014年 apple. All rights reserved.
//

#import "GoHomeViewController.h"

extern NSMutableArray *allStationArray;

@interface GoHomeViewController ()

@end

@implementation GoHomeViewController
@synthesize detailLabel,startTimeLabel,endTimeLabel;
@synthesize startView,endView,sc;
@synthesize startKuangImage1,startPlace1;
@synthesize startKuangImage2,endPlace2;
@synthesize array;
@synthesize price;

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    d=[Dijkstra new];
    // Do any additional setup after loading the view from its nib.
    [_titleView setBackgroundColor:[UIColor colorWithRed:0.22 green:0.7 blue:0.76 alpha:0.9]];
    _StartEndVuew.layer.borderWidth = 1;
    _StartEndVuew.layer.borderColor = [[UIColor colorWithRed:0.22 green:0.7 blue:0.76 alpha:0.9] CGColor];
    _StartEndVuew.layer.cornerRadius =5;
    
    
    NSUserDefaults *defaults=[NSUserDefaults standardUserDefaults];
    _endLabel.text=[defaults objectForKey:@"home"];
    
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(homeTextAction:) name:@"homeText" object:nil];//家的位置改变通知
    
    
    detailLabel=[[UILabel alloc]initWithFrame:CGRectMake(20,170,self.view.frame.size.width-40,20)];
    detailLabel.backgroundColor=[UIColor clearColor];
    detailLabel.font=[UIFont systemFontOfSize:13];
    [self.view addSubview:detailLabel];
#pragma mark -scrollview
    {
        sc=[[UIScrollView alloc]initWithFrame:CGRectMake(0,190, self.view.frame.size.width, self.view.frame.size.height-190)];
        sc.showsVerticalScrollIndicator=NO;
        [sc setBackgroundColor:[UIColor clearColor]];
        [self.view addSubview:sc];
    }
    [self addView];
    
    if([CLLocationManager locationServicesEnabled])
    {
        if([CLLocationManager authorizationStatus] == kCLAuthorizationStatusDenied)
        {
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"定位未开启" delegate:nil cancelButtonTitle:nil otherButtonTitles:@"确定", nil];
            [alert show];
            
            [sc setHidden:YES];
            detailLabel.frame=CGRectMake(20,220,self.view.frame.size.width-40,30);
            detailLabel.text=@"没有查询结果";
            detailLabel.textAlignment=NSTextAlignmentCenter;
        }
        else{
            locationManager = [[CLLocationManager alloc]init];
            locationManager.delegate = self;
            locationManager.desiredAccuracy=kCLLocationAccuracyBest;
            locationManager.distanceFilter = 100.0f;
            homeFlag=@"无";
            [locationManager startUpdatingLocation];
        }
    }
    else{
        NSLog(@"定位未开启。。。。。。。。。");
        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"定位未开启" delegate:nil cancelButtonTitle:nil otherButtonTitles:@"确定", nil];
        [alert show];
        
        [sc setHidden:YES];
        detailLabel.frame=CGRectMake(20,220,self.view.frame.size.width-40,30);
        detailLabel.text=@"没有查询结果";
        detailLabel.textAlignment=NSTextAlignmentCenter;
    }
    [sc setHidden:YES];
}
-(void)addView
{
    startTimeLabel=[[UILabel alloc]initWithFrame:CGRectMake(20,0, 200, 20)];
    startTimeLabel.text=@"首末班次 xx:xx";
    startTimeLabel.font=[UIFont systemFontOfSize:13];
    [sc addSubview:startTimeLabel];
    
    endTimeLabel=[[UILabel alloc]initWithFrame:CGRectMake(100,720, 200, 20)];
    endTimeLabel.text=@"首末班次 xx:xx";
    endTimeLabel.font=[UIFont systemFontOfSize:13];
    [sc addSubview:endTimeLabel];
    
    
    startView=[[UIView alloc]initWithFrame:CGRectMake(0,25, self.view.frame.size.width,20)];
    startView.backgroundColor=[UIColor redColor];
    [sc addSubview:startView];
    
    startKuangImage1=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_kuang_0"]];
    startKuangImage1.frame=CGRectMake(60,-5,30,30);
    [startView addSubview:startKuangImage1];
    
    UILabel *start=[[UILabel alloc]initWithFrame:CGRectMake(0, 0, 30, 30)];
    start.text=@"起";
    start.backgroundColor=[UIColor clearColor];
    start.textAlignment=NSTextAlignmentCenter;
    start.textColor=[UIColor colorWithRed:0.11 green:0.42 blue:0.26 alpha:1];
    [startKuangImage1 addSubview:start];
    
    startPlace1=[[UILabel alloc]initWithFrame:CGRectMake(100, 0, 200,20)];
    startPlace1.font=[UIFont boldSystemFontOfSize:12];
    startPlace1.textColor=[UIColor whiteColor];
    startPlace1.backgroundColor=[UIColor clearColor];
    startPlace1.text=_startLabel.text;
    [startView addSubview:startPlace1];
    
    UIImageView *imageV=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_btn_forward"]];
    imageV.frame=CGRectMake(startView.frame.size.width-25,0, 20, 20);
    [startView addSubview:imageV];
    
    endView=[[UIView alloc]initWithFrame:CGRectMake(0,sc.frame.size.height-25, self.view.frame.size.width,20)];
    endView.backgroundColor=[UIColor redColor];
    [sc addSubview:endView];
    
    
    startKuangImage2=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_kuang_0"]];
    startKuangImage2.frame=CGRectMake(60,-5,30,30);
    [endView addSubview:startKuangImage2];
    
    UILabel *end=[[UILabel alloc]initWithFrame:CGRectMake(0,0, 30, 30)];
    end.text=@"终";
    end.backgroundColor=[UIColor clearColor];
    end.textAlignment=NSTextAlignmentCenter;
    end.textColor=[UIColor colorWithRed:0.11 green:0.42 blue:0.26 alpha:1];
    [startKuangImage2 addSubview:end];
    
    endPlace2=[[UILabel alloc]initWithFrame:CGRectMake(100,0, 200,20)];
    endPlace2.font=[UIFont boldSystemFontOfSize:12];
    endPlace2.textColor=[UIColor whiteColor];
    endPlace2.backgroundColor=[UIColor clearColor];
    endPlace2.text=_endLabel.text;
    [endView addSubview:endPlace2];
    
    UIImageView *imageV1=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_btn_forward"]];
    imageV1.frame=CGRectMake(endView.frame.size.width-25,0, 20, 20);
    [endView addSubview:imageV1];
    
}
//通知
-(void)homeTextAction:(NSNotification *)nof
{
    _endLabel.text=[nof object];
    [[NSUserDefaults standardUserDefaults] setObject:[nof object] forKey:@"home"];
    [[NSUserDefaults standardUserDefaults]synchronize];
    
    [self query];
}
- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (IBAction)backAction:(id)sender {
    [self dismissModalViewControllerAnimated:YES];
}

#pragma mark-locationManagerDelegate methods
- (void)locationManager:(CLLocationManager *)manager
    didUpdateToLocation:(CLLocation *)newLocation
           fromLocation:(CLLocation *)oldLocation
{
    
    NSString *lat = [[NSString alloc] initWithFormat:@"%f",[newLocation coordinate].latitude];
    NSString *lon = [[NSString alloc] initWithFormat:@"%f",[newLocation coordinate].longitude];
    
    CLGeocoder *myGecoder = [[CLGeocoder alloc] init];
    [myGecoder reverseGeocodeLocation:newLocation completionHandler:^(NSArray *placemarks, NSError *error)
     {
         if(error == nil && [placemarks count]>0)
         {
             CLPlacemark *placemark = [placemarks objectAtIndex:0];
             
             NSLog(@"Country = %@", placemark.country);
             NSLog(@"administrativeArea = %@",placemark.administrativeArea);
             NSLog(@"locality = %@", placemark.locality);
             NSLog(@"subLocality=%@",placemark.subLocality);
             NSLog(@"thoroughfare = %@", placemark.thoroughfare);
             NSLog(@"subThoroughfare=%@",placemark.subThoroughfare);
             
         }
         else if(error==nil && [placemarks count]==0)
         {
             NSLog(@"No results were returned.");
         }
         else if(error != nil)
         {
             NSLog(@"An error occurred = %@",error);
         }
     }];
    
    //更新定位信息方法
    NSLog(@"定位 经度%@,纬度%@",lat,lon);
    [locationManager stopUpdatingLocation];
    NSDictionary *dict=[[NSDictionary alloc]initWithObjectsAndKeys:lat,lon,nil];

    NSMutableDictionary *minDistanceDic=[[NSMutableDictionary alloc]init];
    
    for (int i=0; i<[allStationArray count]; i++)
    {
        if([[[allStationArray objectAtIndex:i] objectForKey:@"ZOPEN"]floatValue]==1)
        {
            //查询数据库得到
            float a= [[[allStationArray objectAtIndex:i] objectForKey:@"ZLATITUDE"] floatValue];
            float b= [[[allStationArray objectAtIndex:i] objectForKey:@"ZLONGITUDE"] floatValue];
            //定位得出的
            float c=[[[dict allValues] objectAtIndex:0] floatValue];
            float d1=[[[dict allKeys] objectAtIndex:0] floatValue];
            
            CLLocation *location=[[CLLocation alloc] initWithLatitude:a longitude:b];
            CLLocationDistance distance=[location distanceFromLocation:[[CLLocation alloc] initWithLatitude:c longitude:d1]];
            
            [minDistanceDic setValue:[NSNumber numberWithFloat:distance] forKey:[[allStationArray objectAtIndex:i]objectForKey:@"ZNAME"]];
        }
    }
    NSArray *ar=[minDistanceDic allValues];
    ar=[ar sortedArrayUsingComparator:^NSComparisonResult(id obj1, id obj2) {
        NSComparisonResult result = [obj1 compare:obj2];
        return result==NSOrderedDescending;
    }];
    [minDistanceDic enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) {
        float a=[obj floatValue];
        float b=[[ar objectAtIndex:0] floatValue];
        if(a==b)
        {
            if([homeFlag  isEqualToString:@"家"])
            {
                 _startLabel.text=key;
                 _endLabel.text=key;
                [[NSUserDefaults standardUserDefaults] setObject:key forKey:@"home"];
                [[NSUserDefaults standardUserDefaults]synchronize];
                
                [self query];
                [sc setHidden:NO];
            }
            else
            {
                _startLabel.text=key;
                [self query];
                [sc setHidden:NO];
            }
        }
    }];
    
    if([_startLabel.text isEqualToString:_endLabel.text]){
         [sc setHidden:YES];
        detailLabel.frame=CGRectMake(20,220,self.view.frame.size.width-40,30);
        detailLabel.text=@"没有查询结果";
        detailLabel.textAlignment=NSTextAlignmentCenter;
    }
}

- (void)locationManager:(CLLocationManager *)manager
       didFailWithError:(NSError *)error
{
    //定位失败
    [locationManager stopUpdatingLocation];
}

-(void)query
{
    d->StrBegin=_startLabel.text;
    d->StrEnd=_endLabel.text;
    [d BuildGraph];
    
    sortPassStationArray=[[NSMutableArray alloc]init];
    for (NSString *str in [d.passStationArray reverseObjectEnumerator]) {
        [sortPassStationArray addObject:str];
    }
    if([sortPassStationArray count]>0){
        [sortPassStationArray removeObjectAtIndex:0];
    }
    
    [self getPlaces:sortPassStationArray];
    detailLabel.frame=CGRectMake(20,170,self.view.frame.size.width-40,20);
    detailLabel.textAlignment=NSTextAlignmentLeft;
    [sc setHidden:NO];
}

- (IBAction)settingAction:(id)sender {
    UIActionSheet *action=[[UIActionSheet alloc]initWithTitle:@"修改家的位置" delegate:self cancelButtonTitle:@"取消" destructiveButtonTitle:@"当前位置设为“家" otherButtonTitles:@"自定义",@"清空设置", nil];
    [action showInView:self.view];
}

- (IBAction)moveAction:(id)sender
{
    NSString *start=_startLabel.text;
    NSString *end=_endLabel.text;
    
    _startLabel.text=end;
    _endLabel.text=start;
    
    if([_startLabel.text isEqualToString:_endLabel.text]){
        [sc setHidden:YES];
        detailLabel.frame=CGRectMake(20,220,self.view.frame.size.width-40,30);
        detailLabel.text=@"没有查询结果";
        detailLabel.textAlignment=NSTextAlignmentCenter;
    }
    else if(_startLabel.text.length>0&&_endLabel.text.length>0)
    {
        [self query];
    }
}
#pragma mark actionSheet delegate
-(void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if(buttonIndex==0)
    {
        if([CLLocationManager locationServicesEnabled])
        {
            if([CLLocationManager authorizationStatus] == kCLAuthorizationStatusDenied)
            {
                UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"定位未开启" delegate:nil cancelButtonTitle:nil otherButtonTitles:@"确定", nil];
                [alert show];
            }
            else
            {
                homeFlag=@"家";
                [locationManager startUpdatingLocation];            }
        }
        else
        {
            UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"定位未开启" delegate:nil cancelButtonTitle:nil otherButtonTitles:@"确定", nil];
            [alert show];
        }
    }
    else if (buttonIndex==1)
    {
        SelectHomeViewController *home=[[SelectHomeViewController alloc]initWithNibName:IS_IPHONE5?@"SelectHomeViewController_4":@"SelectHomeViewController_3.5" bundle:nil];
        home.flag=@"1";
        [self presentModalViewController:home animated:YES];
    }
    else if (buttonIndex==2)
    {
        UIAlertView *alert=[[UIAlertView alloc]initWithTitle:@"提示" message:@"此操作会将原有的设置和数据进行清空，确定么？" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确定", nil];
        [alert show];
    }
}
#pragma mark -alert delegate
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if(buttonIndex==1){
        [[NSUserDefaults standardUserDefaults]removeObjectForKey:@"home"];
        [[NSUserDefaults standardUserDefaults]synchronize];
        
        MBProgressHUD *HUD = [[MBProgressHUD alloc] initWithView:self.view];
        [self.view.superview addSubview:HUD];
        HUD.labelText = @"清空成功";
        HUD.mode = MBProgressHUDModeText;
        [HUD showAnimated:YES whileExecutingBlock:^{
            sleep(1.5);
        } completionBlock:^{
            [HUD removeFromSuperview];
        }];
        [self dismissViewControllerAnimated:YES completion:^{
            
        }];
    }
}

#pragma mark -列出路线
-(void)getPlaces:(NSMutableArray *)palcesLineArray
{
    for (UIView *s in [sc subviews]) {
        [s removeFromSuperview];
    }
    
    [self addView];
    price=[Dijkstra price:_startLabel.text end:_endLabel.text array:palcesLineArray];//计算价格已经加上起点和终点了  顺序不能换
    
    changeArray1=[Dijkstra transLine:palcesLineArray s:_startLabel.text s1:_endLabel.text];
    [self getLineAndColor:_startLabel.text str:_endLabel.text];
    
    NSMutableArray *changeDirectionLineArray=[self changeLineDirection:changeArray1 passStation:palcesLineArray];
    NSMutableArray *arrayLine=[[NSMutableArray alloc]init];
    if([[palcesLineArray objectAtIndex:0] hasSuffix:@"（未开通）"])
    {
        NSRange range=[[palcesLineArray objectAtIndex:0] rangeOfString:@"（"];
        NSString *str=[[palcesLineArray objectAtIndex:0] substringWithRange:NSMakeRange(0, range.location)];
        arrayLine=[SqliteDao findLineByStationId:str];//得出几号线
    }
    else
    {
        arrayLine=[SqliteDao findLineByStationId:[palcesLineArray objectAtIndex:0]];//得出几号线
    }
    
    
    [palcesLineArray removeObject:_startLabel.text];
    [palcesLineArray removeObject:_endLabel.text];
    
    [self direction:palcesLineArray];
    
    ///////////////////////画线
    stationView=[[LineStationView alloc]initWithFrame:CGRectMake(0,50, sc.frame.size.width,20)];
    [sc addSubview:stationView];
    
    UIImageView *im=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, sc.frame.size.width,20)];
    im.backgroundColor=[UIColor clearColor];
    [stationView addSubview:im];
    
    UILabel *directionLabel=[[UILabel alloc]initWithFrame:CGRectMake(175,0,200,20)];
    directionLabel.backgroundColor=[UIColor clearColor];
    directionLabel.font=[UIFont systemFontOfSize:10];
    directionLabel.textColor=[UIColor grayColor];
    [im addSubview:directionLabel];
    
    NSString *lineStr;
    if(arrLinePub.count>0)
        lineStr=[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINENUMBER"];
    else
        lineStr=[[arrayLine objectAtIndex:0]objectForKey:@"ZLINENUMBER"];
    
    directionLabel.text=[NSString stringWithFormat:@"%@号线 去往%@方向",lineStr,direction];
    
    UIGraphicsBeginImageContext(im.frame.size);
    [im.image drawInRect:CGRectMake(0, 0, im.frame.size.width, im.frame.size.height)];
    CGContextRef context=UIGraphicsGetCurrentContext();
    CGContextSetLineWidth(context,1);
    CGContextSetRGBStrokeColor(context,0.0, 0.0, 0.0, 1.0);
    CGContextSetShouldAntialias(context, NO);
    CGContextBeginPath(context);
    CGContextMoveToPoint(context,75,0);
    CGContextAddLineToPoint(context,75,20);
    CGContextStrokePath(context);
    im.image=UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    for (int i=0;i<[palcesLineArray count];i++)
    {
        //NSLog(@"-----列出路线----个数---%@----%i",[palcesLineArray objectAtIndex:i],palcesLineArray.count);
        if(i==0)
        {
            stationView=[[LineStationView alloc]initWithFrame:CGRectMake(0,70, sc.frame.size.width,40)];
            [sc addSubview:stationView];
            
            UIImageView *im=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, sc.frame.size.width,40)];
            im.backgroundColor=[UIColor clearColor];
            [stationView addSubview:im];
            
            
            UILabel *stationLabel=[[UILabel alloc]initWithFrame:CGRectMake(85,10,105,20)];
            stationLabel.backgroundColor=[UIColor clearColor];
            stationLabel.textColor=[UIColor grayColor];
            stationLabel.font=[UIFont systemFontOfSize:13];
            stationLabel.text=[palcesLineArray objectAtIndex:i];
            [im addSubview:stationLabel];
            
            UIGraphicsBeginImageContext(im.frame.size);
            [im.image drawInRect:CGRectMake(0, 0, im.frame.size.width, im.frame.size.height)];
            CGContextRef context=UIGraphicsGetCurrentContext();
            CGContextSetLineWidth(context,1);
            CGContextSetRGBStrokeColor(context,0.0, 0.0, 0.0, 1.0);
            CGContextSetShouldAntialias(context, NO);
            CGContextBeginPath(context);
            CGContextMoveToPoint(context,75,0);
            CGContextAddLineToPoint(context,75,40);
            CGContextStrokePath(context);
            
            CGContextSetFillColorWithColor(context, [UIColor grayColor].CGColor);
            CGContextAddArc(context,75,20,3.5, 0,2*PI, 0);
            CGContextFillPath(context);
            
            im.image=UIGraphicsGetImageFromCurrentImageContext();
            UIGraphicsEndImageContext();
            
            for (NSString *s in changeArray1) {
                if([[palcesLineArray objectAtIndex:i] isEqualToString:s])
                {
//                    NSMutableArray *startArray=[SqliteDao findLineByStationId:s];
//                    NSString *color=[[startArray objectAtIndex:0]objectForKey:@"ZCOLOR"];
                    
                    NSString *color=[[arrayPublicLine objectAtIndex:0]objectForKey:@"ZCOLOR"];
                    color=[color substringWithRange:NSMakeRange(5, color.length-6)];
                    NSArray *colorArray=[color componentsSeparatedByString:@","];
                    
                    im.backgroundColor=RGB([colorArray[0] floatValue], [colorArray[1] floatValue], [colorArray[2] floatValue], [colorArray[3] floatValue]);
                    stationLabel.textColor=[UIColor whiteColor];
                    
                    UILabel *directoinLineLabel=[[UILabel alloc]initWithFrame:CGRectMake(175,20,120, 20)];
                    directoinLineLabel.textColor=[UIColor whiteColor];
                    directoinLineLabel.backgroundColor=[UIColor clearColor];
                    directoinLineLabel.font=[UIFont systemFontOfSize:10];
                    [im addSubview:directoinLineLabel];
                    
                    directoinLineLabel.text=[NSString stringWithFormat:@"%@号线 去往%@方向",[changeDirectionLineArray[0] objectAtIndex:0],[changeDirectionLineArray[0] objectAtIndex:1]];
                    
                    UIImageView *imageV1=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_btn_forward"]];
                    imageV1.frame=CGRectMake(im.frame.size.width-25,10, 20, 20);
                    [im addSubview:imageV1];
                    
                    UITapGestureRecognizer *tap=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(startTap:)];
                    im.userInteractionEnabled=YES;
                    [im addGestureRecognizer:tap];
                }
            }
        }
        else
        {
            if(i==1)
            {
                stationView=[[LineStationView alloc]initWithFrame:CGRectMake(0,110, sc.frame.size.width,40)];
                [sc addSubview:stationView];
            }
            else if(i==2)
            {
                stationView=[[LineStationView alloc]initWithFrame:CGRectMake(0,150, sc.frame.size.width,40)];
                [sc addSubview:stationView];
            }
            else
            {
                stationView=[[LineStationView alloc]initWithFrame:CGRectMake(0,150+40*(i-2), sc.frame.size.width,40)];
                [sc addSubview:stationView];
            }
            UIImageView *im=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, sc.frame.size.width,40)];
            im.backgroundColor=[UIColor clearColor];
            [stationView addSubview:im];
            
            UILabel *stationLabel=[[UILabel alloc]initWithFrame:CGRectMake(85,13,105,20)];
            stationLabel.backgroundColor=[UIColor clearColor];
            stationLabel.textColor=[UIColor grayColor];
            stationLabel.font=[UIFont systemFontOfSize:13];
            stationLabel.text=[palcesLineArray objectAtIndex:i];
            [im addSubview:stationLabel];
            
            UIGraphicsBeginImageContext(im.frame.size);
            [im.image drawInRect:CGRectMake(0, 0, im.frame.size.width, im.frame.size.height)];
            CGContextRef context=UIGraphicsGetCurrentContext();
            CGContextSetLineWidth(context,1);
            CGContextSetRGBStrokeColor(context,0.0, 0.0, 0.0, 1.0);
            CGContextSetShouldAntialias(context, NO);
            CGContextBeginPath(context);
            CGContextMoveToPoint(context,75,0);
            CGContextAddLineToPoint(context,75,40);
            CGContextStrokePath(context);
            
            CGContextSetFillColorWithColor(context, [UIColor grayColor].CGColor);
            CGContextAddArc(context,75,22,3.5, 0,2*PI, 0);
            CGContextFillPath(context);
            
            im.image=UIGraphicsGetImageFromCurrentImageContext();
            UIGraphicsEndImageContext();
            
            
            for (int j=0; j<changeArray1.count;j++) {
                if([[palcesLineArray objectAtIndex:i] isEqualToString:[changeArray1 objectAtIndex:j]])
                {
//                    NSMutableArray *startArray=[SqliteDao findLineByStationId:[changeArray1 objectAtIndex:j]];
//                    NSString *color=[[startArray objectAtIndex:0]objectForKey:@"ZCOLOR"];
                    
                    NSString *color=[[arrayPublicLine objectAtIndex:j]objectForKey:@"ZCOLOR"];
                    color=[color substringWithRange:NSMakeRange(5, color.length-6)];
                    NSArray *colorArray=[color componentsSeparatedByString:@","];
                    
                    im.backgroundColor=RGB([colorArray[0] floatValue], [colorArray[1] floatValue], [colorArray[2] floatValue], [colorArray[3] floatValue]);
                    stationLabel.textColor=[UIColor whiteColor];
                    
                    UILabel *directoinLineLabel=[[UILabel alloc]initWithFrame:CGRectMake(175,10,120, 20)];
                    directoinLineLabel.textColor=[UIColor whiteColor];
                    directoinLineLabel.backgroundColor=[UIColor clearColor];
                    directoinLineLabel.font=[UIFont systemFontOfSize:10];
                    [im addSubview:directoinLineLabel];
                    directoinLineLabel.text=[NSString stringWithFormat:@"%@号线 去往%@方向",[[changeDirectionLineArray objectAtIndex:j] objectAtIndex:0],[[changeDirectionLineArray objectAtIndex:j] objectAtIndex:1]];
                    
                    UIImageView *imageV1=[[UIImageView alloc]initWithImage:[UIImage imageNamed:@"iPhone_btn_forward"]];
                    imageV1.frame=CGRectMake(im.frame.size.width-25,10, 20, 20);
                    [im addSubview:imageV1];
                    
                    UITapGestureRecognizer *tap=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(startTap:)];
                    im.userInteractionEnabled=YES;
                    [im addGestureRecognizer:tap];
                }
            }
        }
    }
    
    LineStationView *stationV=[[LineStationView alloc]initWithFrame:CGRectMake(0,((palcesLineArray.count-1)*40)+110, sc.frame.size.width,20)];
    [sc addSubview:stationV];
    
    UIImageView *im1=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, sc.frame.size.width, 20)];
    im1.backgroundColor=[UIColor clearColor];
    [stationV addSubview:im1];
    
    UIGraphicsBeginImageContext(im1.frame.size);
    [im1.image drawInRect:CGRectMake(0, 0, im1.frame.size.width, im1.frame.size.height)];
    CGContextRef context1=UIGraphicsGetCurrentContext();
    CGContextSetLineWidth(context1,1);
    CGContextSetRGBStrokeColor(context1,0.0, 0.0, 0.0, 1.0);
    CGContextSetShouldAntialias(context1, NO);
    CGContextBeginPath(context1);
    CGContextMoveToPoint(context1,75,0);
    CGContextAddLineToPoint(context1,75,20);
    CGContextStrokePath(context1);
    im1.image=UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    
    
    if(palcesLineArray.count>0)
        endView.frame=CGRectMake(0, sc.frame.origin.y+((palcesLineArray.count-1)*40)-55,CGRectGetWidth(self.view.frame), 20);
    else
        endView.frame=CGRectMake(0,95,CGRectGetWidth(self.view.frame), 20);
    
    endTimeLabel.frame=CGRectMake(20, endView.frame.origin.y+25,CGRectGetWidth(self.view.frame), 20);
    [sc setContentSize:CGSizeMake(0,((palcesLineArray.count-1)*40)+185)];
    
    if(changeArray1.count==0)
        detailLabel.text=[NSString stringWithFormat:@"%i站\t\t\t%@元",d->length-1,price];
    else
        detailLabel.text=[NSString stringWithFormat:@"%i站，换乘%i次\t\t\t%@元",d->length-1,changeArray1.count,price];
    
    NSMutableDictionary *dictTime=[SqliteDao findStartAndEndTime1:startPlace1.text str:direction];
    if(dictTime.count==0)
    {
        NSMutableArray *arrayTime1=[SqliteDao findStartAndEndTime:startPlace1.text];
        if(arrayTime1.count==1)
            startTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[[arrayTime1 objectAtIndex:0] objectForKey:@"ZSTARTTIME"],[[arrayTime1 objectAtIndex:0] objectForKey:@"ZENDTIME"]];
        if(arrayTime1.count>1)
            startTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[[arrayTime1 objectAtIndex:1] objectForKey:@"ZSTARTTIME"],[[arrayTime1 objectAtIndex:1] objectForKey:@"ZENDTIME"]];
    }
    else
        startTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[dictTime objectForKey:@"ZSTARTTIME"],[dictTime objectForKey:@"ZENDTIME"]];
    
    
    NSMutableDictionary *dictTime1;
    if(changeDirectionLineArray.count>0)
        dictTime1=[SqliteDao findStartAndEndTime1:_endLabel.text str:changeDirectionLineArray[changeDirectionLineArray.count-1][1]];
    else
        dictTime1=[SqliteDao findStartAndEndTime1:_endLabel.text str:direction];
    
    if(dictTime1.count==0)
    {
        NSMutableArray *arrayTime1=[SqliteDao findStartAndEndTime:_endLabel.text];
        if(arrayTime1.count==1)
            endTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[[arrayTime1 objectAtIndex:0] objectForKey:@"ZSTARTTIME"],[[arrayTime1 objectAtIndex:0] objectForKey:@"ZENDTIME"]];
        if(arrayTime1.count>1)
            endTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[[arrayTime1 objectAtIndex:1] objectForKey:@"ZSTARTTIME"],[[arrayTime1 objectAtIndex:1] objectForKey:@"ZENDTIME"]];
    }
    else
        endTimeLabel.text=[NSString stringWithFormat:@"首末班次：%@/%@",[dictTime1 objectForKey:@"ZSTARTTIME"],[dictTime1 objectForKey:@"ZENDTIME"]];
    
}
-(void)direction:(NSMutableArray *)palcesLine
{
    NSMutableArray *palcesLineArray=[[NSMutableArray alloc]initWithArray:palcesLine];
    [palcesLineArray insertObject:_startLabel.text atIndex:0];
    [palcesLineArray insertObject:_endLabel.text atIndex:palcesLineArray.count];
    
    
    if(arrLinePub.count>0)
    {
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==1)
        {
            NSInteger a=[line1 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line1 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line1 lastObject];
            }
            else
            {
                direction=[line1 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==2)
        {
            NSInteger a=[line2 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line2 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line2 lastObject];
            }
            else
            {
                direction=[line2 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==3)
        {
            NSInteger a=[line3A indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line3A indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line3A lastObject];
            }
            else
            {
                direction=[line3A firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==4)
        {
            NSInteger a=[line3B indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line3B indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line3B lastObject];
            }
            else
            {
                direction=[line3B firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==5)
        {
            NSInteger a=[line4 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line4 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line4 lastObject];
            }
            else
            {
                direction=[line4 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==6)
        {
            NSInteger a=[line5 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line5 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line5 lastObject];
            }
            else
            {
                direction=[line5 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==10)
        {
            NSInteger a=[line6 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line6 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line6 lastObject];
            }
            else
            {
                direction=[line6 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==7)
        {
            NSInteger a=[line8 indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[line8 indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[line8 lastObject];
            }
            else
            {
                direction=[line8 firstObject];
            }
        }
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==8)
        {
            NSInteger a=[lineGF indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[lineGF indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[lineGF lastObject];
            }
            else
            {
                direction=[lineGF firstObject];
            }
        }
        
        
        if([[[arrLinePub objectAtIndex:0]objectForKey:@"ZLINEID"] integerValue]==9)
        {
            NSInteger a=[lineAPM indexOfObject:[palcesLineArray objectAtIndex:0]];
            NSInteger b=[lineAPM indexOfObject:[palcesLineArray objectAtIndex:1]];
            
            if (a<b) {
                direction=[lineAPM lastObject];
            }
            else
            {
                direction=[lineAPM firstObject];
            }
        }
    }
    
}
-(NSMutableArray *)changeLineDirection:(NSMutableArray *)changeLineArray passStation:(NSMutableArray *)passStationArray
{
    
    [arrayPublicLine removeAllObjects];
    
    for (int j=0; j<passStationArray.count; j++)
    {
        for (int i=0; i<changeLineArray.count; i++)
        {
            if([changeLineArray[i] isEqualToString:passStationArray[j]])
            {
                NSString *zhanCurr = passStationArray[j];
                NSString *zhanNext = passStationArray[j+1];
                
                NSArray *arrayCurr;
                NSArray *arrayNext;
                arrayCurr= [SqliteDao findLineByStationId:zhanCurr];
                arrayNext= [SqliteDao findLineByStationId:zhanNext];
                
                NSMutableSet *lineCurr=[[NSMutableSet alloc]initWithArray:arrayCurr];
                NSMutableSet *lineNext=[[NSMutableSet alloc]initWithArray:arrayNext];
                
                [lineCurr intersectSet:lineNext];
                
                // TODO:计算当前站和下一个站的公共 地铁线，得到两个字站共同的地铁线
                NSObject *linePub = [lineCurr anyObject];
                
                if(linePub!=nil)
                    [arrayPublicLine addObject:linePub];
            }
        }
    }
    
    NSMutableArray *changeLineDirection=[NSMutableArray array];
    
    if(changeLineArray.count>0)
    {
        if(passStationArray.count==3)
        {
            NSLog(@"换乘站的下一站:%@",_endLabel.text);
            NSString *dir=@"机场南";//存放转线方向
            NSString *changeLine=@"3";//存放转线站点的哪条线
            
            
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==1)
            {
                changeLine=@"1";
                
                NSInteger a=[line1 indexOfObject:changeLineArray[0]];
                NSInteger b=[line1 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line1 lastObject];
                }
                else
                {
                    dir=[line1 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==2)
            {
                changeLine=@"2";
                
                NSInteger a=[line2 indexOfObject:changeLineArray[0]];
                NSInteger b=[line2 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line2 lastObject];
                }
                else
                {
                    dir=[line2 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==3)
            {
                changeLine=@"3";
                NSInteger a=[line3A indexOfObject:changeLineArray[0]];
                NSInteger b=[line3A indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line3A lastObject];
                }
                else
                {
                    dir=[line3A firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==4)
            {
                changeLine=@"3";
                
                NSInteger a=[line3B indexOfObject:changeLineArray[0]];
                NSInteger b=[line3B indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line3B lastObject];
                }
                else
                {
                    dir=[line3B firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==5)
            {
                changeLine=@"4";
                
                NSInteger a=[line4 indexOfObject:changeLineArray[0]];
                NSInteger b=[line4 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line4 lastObject];
                }
                else
                {
                    dir=[line4 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==6)
            {
                changeLine=@"5";
                
                NSInteger a=[line5 indexOfObject:changeLineArray[0]];
                NSInteger b=[line5 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line5 lastObject];
                }
                else
                {
                    dir=[line5 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==10)
            {
                changeLine=@"6";
                
                NSInteger a=[line6 indexOfObject:changeLineArray[0]];
                NSInteger b=[line6 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line6 lastObject];
                }
                else
                {
                    dir=[line6 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==7)
            {
                changeLine=@"8";
                
                NSInteger a=[line8 indexOfObject:changeLineArray[0]];
                NSInteger b=[line8 indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[line8 lastObject];
                }
                else
                {
                    dir=[line8 firstObject];
                }
            }
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==8)
            {
                changeLine=@"GF";
                
                NSInteger a=[lineGF indexOfObject:changeLineArray[0]];
                NSInteger b=[lineGF indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[lineGF lastObject];
                }
                else
                {
                    dir=[lineGF firstObject];
                }
            }
            
            
            if([[[arrLinePub objectAtIndex:1]objectForKey:@"ZLINEID"] integerValue]==9)
            {
                changeLine=@"APM";
                
                NSInteger a=[lineAPM indexOfObject:changeLineArray[0]];
                NSInteger b=[lineAPM indexOfObject:_endLabel.text];
                
                if (a<b) {
                    dir=[lineAPM lastObject];
                }
                else
                {
                    dir=[lineAPM firstObject];
                }
            }
            
            [changeLineDirection addObject:@[changeLine,dir]];
        }
        else
        {
            NSMutableArray *arrayIndex=[NSMutableArray array];
            for (int i=0; i<changeLineArray.count; i++) {
                [arrayIndex addObject:[NSNumber numberWithInteger:[passStationArray indexOfObject:changeLineArray[i]]]];
            }
            
            for (int i=0;i<arrayIndex.count;i++) {
                
                NSString *dir=@"机场南";//存放转线方向
                NSString *changeLine=@"3";//存放转线站点的哪条线
                
                NSString *s=arrayIndex[i];
                
                NSString *zhanNext=[passStationArray objectAtIndex:[s integerValue]+1];//转线的下一个站点
                NSLog(@"--超过3个站点换乘站的下一站--%@",zhanNext);
                
                
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==1)
                {
                    changeLine=@"1";
                    
                    NSInteger a=[line1 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line1 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line1 lastObject];
                    }
                    else
                    {
                        dir=[line1 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==2)
                {
                    changeLine=@"2";
                    
                    NSInteger a=[line2 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line2 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line2 lastObject];
                    }
                    else
                    {
                        dir=[line2 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==3)
                {
                    changeLine=@"3";
                    NSInteger a=[line3A indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line3A indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line3A lastObject];
                    }
                    else
                    {
                        dir=[line3A firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==4)
                {
                    changeLine=@"3";
                    NSInteger a=[line3B indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line3B indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line3B lastObject];
                    }
                    else
                    {
                        dir=[line3B firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==5)
                {
                    changeLine=@"4";
                    NSInteger a=[line4 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line4 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line4 lastObject];
                    }
                    else
                    {
                        dir=[line4 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==6)
                {
                    changeLine=@"5";
                    NSInteger a=[line5 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line5 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line5 lastObject];
                    }
                    else
                    {
                        dir=[line5 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==10)
                {
                    changeLine=@"6";
                    NSInteger a=[line6 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line6 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line6 lastObject];
                    }
                    else
                    {
                        dir=[line6 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==7)
                {
                    changeLine=@"8";
                    NSInteger a=[line8 indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[line8 indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[line8 lastObject];
                    }
                    else
                    {
                        dir=[line8 firstObject];
                    }
                }
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==8)
                {
                    changeLine=@"GF";
                    NSInteger a=[lineGF indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[lineGF indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[lineGF lastObject];
                    }
                    else
                    {
                        dir=[lineGF firstObject];
                    }
                }
                
                
                if([[[arrayPublicLine objectAtIndex:i]objectForKey:@"ZLINEID"] integerValue]==9)
                {
                    changeLine=@"APM";
                    NSInteger a=[lineAPM indexOfObject:[passStationArray objectAtIndex:[s integerValue]]];
                    NSInteger b=[lineAPM indexOfObject:zhanNext];
                    
                    if (a<b) {
                        dir=[lineAPM lastObject];
                    }
                    else
                    {
                        dir=[lineAPM firstObject];
                    }
                }
                [changeLineDirection addObject:@[changeLine,dir]];
            }
        }
    }
//    for (NSString *  s in changeLineDirection) {
//        NSLog(@"change line and direction:%@",s);
//    }
    
    return changeLineDirection;
}
-(void)getLineAndColor:(NSString *)start str:(NSString *)end
{
    NSMutableArray *startArray=[SqliteDao findLineByStationId:start];
    NSMutableArray *endArray=[SqliteDao findLineByStationId:end];
    
    NSString *color=[[startArray objectAtIndex:0]objectForKey:@"ZCOLOR"];
    color=[color substringWithRange:NSMakeRange(5, color.length-6)];
    NSArray *colorArray=[color componentsSeparatedByString:@","];
    
    float red= ([colorArray[0] floatValue])/255;
    float green= ([colorArray[1] floatValue])/255;
    float blue= ([colorArray[2] floatValue])/255;
    float alpha= ([colorArray[3] floatValue]);
    startView.backgroundColor=[UIColor colorWithRed:red green:green blue:blue alpha:alpha];
    UITapGestureRecognizer *startTapGestureRecognizer=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(startTap:)];
    startView.userInteractionEnabled=YES;
    [startView addGestureRecognizer:startTapGestureRecognizer];

    
    
    
    NSString *color1=[[endArray objectAtIndex:0]objectForKey:@"ZCOLOR"];
    color1=[color1 substringWithRange:NSMakeRange(5,color1.length-6)];
    NSArray *colorArray1=[color1 componentsSeparatedByString:@","];
    
    float red1= ([colorArray1[0] floatValue])/255;
    float green1= ([colorArray1[1] floatValue])/255;
    float blue1= ([colorArray1[2] floatValue])/255;
    float alpha1= ([colorArray1[3] floatValue]);
    endView.backgroundColor=[UIColor colorWithRed:red1 green:green1 blue:blue1 alpha:alpha1];
    UITapGestureRecognizer *endTapGestureRecognizer=[[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(endTap:)];
    endView.userInteractionEnabled=YES;
    [endView addGestureRecognizer:endTapGestureRecognizer];
    
    NSString *startFlag=[[startArray objectAtIndex:0]objectForKey:@"ZLINENUMBER"];
    if([startFlag isEqualToString:@"1"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_0"];
    if([startFlag isEqualToString:@"2"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_1"];
    if([startFlag isEqualToString:@"3"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_2"];
    if([startFlag isEqualToString:@"4"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_3"];
    if([startFlag isEqualToString:@"5"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_4"];
    if([startFlag isEqualToString:@"6"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_9"];
    if([startFlag isEqualToString:@"8"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_6"];
    if([startFlag isEqualToString:@"APM"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_8"];
    if([startFlag isEqualToString:@"GF"])
        startKuangImage1.image=[UIImage imageNamed:@"iPhone_kuang_7"];
    
    
    NSString *endFlag=[[endArray objectAtIndex:0]objectForKey:@"ZLINENUMBER"];
    if([endFlag isEqualToString:@"1"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_0"];
    if([endFlag isEqualToString:@"2"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_1"];
    if([endFlag isEqualToString:@"3"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_2"];
    if([endFlag isEqualToString:@"4"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_3"];
    if([endFlag isEqualToString:@"5"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_4"];
    if([endFlag isEqualToString:@"6"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_9"];
    if([endFlag isEqualToString:@"8"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_6"];
    if([endFlag isEqualToString:@"APM"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_8"];
    if([endFlag isEqualToString:@"GF"])
        startKuangImage2.image=[UIImage imageNamed:@"iPhone_kuang_7"];
    
}
#pragma mark -手势事件
-(void)startTap:(UITapGestureRecognizer *)tap
{
    for (UIView *s in [tap view].subviews) {
        if([s isKindOfClass:[UILabel class]])
        {
            NSString *place=((UILabel *)s).text;
            
            InfoViewController *info=[[InfoViewController alloc]init];
            info.place=((UILabel *)s).text;
            info.arrayLine=[SqliteDao findLineByStationId:place];
            
            info.infoArray=[SqliteDao findEntranceByStationId:place];
            
            info.arrayStartAndEndTime=[SqliteDao findStartAndEndTime:place];
            
            [self  presentViewController:info animated:YES completion:^{
                
            }];
        }
    }
}
-(void)endTap:(UITapGestureRecognizer *)tap
{
    for (UIView *s in [tap view].subviews) {
        if([s isKindOfClass:[UILabel class]])
        {
            NSString *place=((UILabel *)s).text;
            
            InfoViewController *info=[[InfoViewController alloc]init];
            info.place=((UILabel *)s).text;
            info.arrayLine=[SqliteDao findLineByStationId:place];
            
            info.infoArray=[SqliteDao findEntranceByStationId:place];
            
            info.arrayStartAndEndTime=[SqliteDao findStartAndEndTime:place];
            
            [self presentViewController:info animated:YES completion:^{
                
            }];
        }
    }
}
@end
